(()=>{"use strict";var t={n:e=>{var n=e&&e.__esModule?()=>e.default:()=>e;return t.d(n,{a:n}),n},d:(e,n)=>{for(var o in n)t.o(n,o)&&!t.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:n[o]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{starter:()=>w});const n=require("http");var o=t.n(n);const r=require("url"),s=require("os");var i=t.n(s);const a=require("fs");var c=t.n(a);const l=i().homedir()+"/.chatbot",u=l+"/data.json",d=()=>{c().existsSync(l)||c().mkdirSync(l),c().existsSync(u)||c().writeFileSync(u,"{}")},g=()=>{d();const t=c().readFileSync(u,"utf8");return JSON.parse(t)},h=t=>{d(),c().writeFileSync(u,JSON.stringify(t))},p={status:(t,e)=>{const n=g();return console.log("[ChatbotAPI] status: ",n),n},login:(t,e)=>{const{chatbotEmitter:n,listenerEmitter:o}=e;return new Promise(((t,e)=>{n.addListener("login",(()=>{console.log("[ChatbotAPI] login: chatbot login"),h(Object.assign(Object.assign({},g()),{status:"waiting"})),t(Object.assign({},g()))})),o.emit("login")}))},logout:(t,e)=>{const{listenerEmitter:n}=e;return n.emit("logout"),{}},message:(t,e)=>{var n;const{listenerEmitter:o}=e;return o.emit("message",null!==(n=t.message)&&void 0!==n?n:t.data),{}}},m=624,f={"/chatbot":{get:(t,e,n)=>{e.writeHead(200,{"Content-Type":"text/plain"}),e.end(JSON.stringify({errcode:"0",errmsg:"GET method received, please use POST method instead!"}))},post:(t,e,n)=>{let o="";t.on("data",(t=>{o+=String(t)})),t.on("end",(()=>{const r=((t,e)=>{const{type:n="message"}=t;return p[n](t,e)})(JSON.parse(o),Object.assign({req:t,res:e},n));r instanceof Promise?r.then((t=>{e.end(JSON.stringify(t))})):e.end(JSON.stringify(r))}))}}};var b=function(t,e,n,o){return new(n||(n=Promise))((function(r,s){function i(t){try{c(o.next(t))}catch(t){s(t)}}function a(t){try{c(o.throw(t))}catch(t){s(t)}}function c(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(i,a)}c((o=o.apply(t,e||[])).next())}))};const v="wechaty-puppet-wechat",S=t=>{process.env.WECHATY_PUPPET=v,process.env.WECHATY_LOG="verbose",process.env.PUPPETEER_SKIP_DOWNLOAD="true";const{wechaty:e,chatbotEmitter:n,listenerEmitter:o}=t,{ScanStatus:r,Wechaty:s,log:i}=e,a={instance:null},c=(t,e)=>{if(e===r.Waiting||e===r.Timeout){const n=["https://wechaty.js.org/qrcode/",encodeURIComponent(t)].join("");(t=>{const e=g();e.qr=t,h(e)})(n),i.info("[Chatbot]","onScan: %s(%s) - %s",r[e],e,n)}else i.info("[Chatbot]","onScan: %s(%s)",r[e],e)},l=t=>{i.info("[Chatbot]","%s login",t)},u=t=>{i.info("[Chatbot]","%s logout",t)},d=t=>b(void 0,void 0,void 0,(function*(){i.info("[Chatbot]",t.toString())})),p=t=>{i.error("[Chatbot]","%s",t)};(()=>{const t=new s({name:"insights-notifier",puppet:v});t.on("scan",c),t.on("login",l),t.on("logout",u),t.on("message",d),t.on("error",p),a.instance=t})(),o.addListener("login",(()=>{const t=a.instance;null!==t&&t.start().then((()=>{i.info("[Chatbot]","Starter Bot Started."),n.emit("login",{})})).catch((t=>i.error("[Chatbot]",t)))})),o.addListener("logout",(()=>{const t=a.instance;null!==t&&new Promise(((e,n)=>{t.logonoff()?e(t.logout().then((()=>{i.info("[Chatbot]","Starter Bot Logout.")}))):e({})})).then((()=>{var t;return null===(t=a.instance)||void 0===t?void 0:t.stop()})).then((()=>{i.info("[Chatbot]","Starter Bot Stopped."),h({})})).catch((t=>i.error("[Chatbot]",t)))}));o.addListener("message",(t=>{try{const e=a.instance;if(null===e)return;e.Room.find({topic:"å›½åŠ¡å·¥ä½œç›‘ç£å§”å‘˜ä¼š"}).then((e=>{null==e||e.say((t=>`ðŸŒ æ¥æ´»å„¿äº†ï¼Œå›½åŠ¡é™¢åˆšåˆšå‘å¸ƒäº†æœ€æ–°æ”¿ç­–ï¼\n\n${t.map((t=>`[${new Date(1e3*t.publishTime).toISOString().slice(0,10)}] ${t.title}: ${t.url}`)).join("\n")}`)(t))}))}catch(t){i.error("[Chatbot] destruct message failed: ",t)}}))},y=require("events");console.log("server code loaded!");const O=new y.EventEmitter,C=new y.EventEmitter,w=t=>{const e=Object.assign(Object.assign({},t),{chatbotEmitter:O,listenerEmitter:C});((t,e)=>{const{port:n=m}=e;o().createServer(((e,n)=>{var o,s,i;const{pathname:a}=new r.URL(null!==(o=e.url)&&void 0!==o?o:"","http://localhost");if(a.startsWith("/api")){const o=a.replace("/api",""),r=null!==(i=null===(s=e.method)||void 0===s?void 0:s.toLowerCase())&&void 0!==i?i:"get",c=f[o],l=null==c?void 0:c[r];"function"==typeof l?l(e,n,t):(n.statusCode=404,n.end())}else n.statusCode=404,n.end("")})).listen(n,(()=>{console.log(`Server is running on http://127.0.0.1:${n}/`)}))})(e,{port:624}),S(e)};module.exports.MobiusLib=e})();